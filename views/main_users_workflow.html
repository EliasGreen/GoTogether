<!-- Start page -->


<!DOCTYPE html>
<html>
  <head>
    <title>GoTogether</title>
    <meta name="description" content="A cool thing made with Glitch">
    <link id="favicon" rel="icon" href="data:image/jpeg;base64,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" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
    
    <link rel="stylesheet" href="/style_main_users_workflow.css">
  </head>
  <body>
    
    <div id="main-block">
     
      <div id="map-block"></div>
      
      <div id="user-inf-block">
        <img id="user-avatar" alt="user-avatar">
        <div id="name"></div>
        <div id="lastname"></div>
        <button id="logout">
          Logout
        </button>
        <div class="line"></div>
        <h3>
          Your comment:
        </h3>
        <textarea id="comment" name="comment" cols="40" rows="9"></textarea>
        <button id="start-searching">
          Find a partner!
        </button>
      </div>
      
    </div> 
    <!-- Scripts -->
    
    <script> 
      function initMap() {
         if ("geolocation" in navigator) {
           // get user img
           const xhr = new XMLHttpRequest();

            xhr.open('GET', '/user-inf', true);

            xhr.send();

            xhr.onreadystatechange = function() {
              if (this.readyState != 4) return;
              if (this.status != 200) {
                alert( 'error: ' + (this.status ? this.statusText : 'request has not been set') );
                return;
              }
              let response = JSON.parse(this.responseText);
                //set the map
                navigator.geolocation.getCurrentPosition(function(position) { 
                  let myPosition = {lat: position.coords.latitude, lng: position.coords.longitude};
                  const map = new google.maps.Map(document.getElementById("map-block"), {
                      zoom: 16,
                      center: myPosition
                    });
                  
                  // GET all markers by other users
                    xhr.open('GET', '/markers', true);
                    xhr.send();
                   
                    xhr.onreadystatechange = function() {
                      if (this.readyState != 4) return;
                      if (this.status != 200) {
                        alert( 'error: ' + (this.status ? this.statusText : 'request has not been set') );
                        return;
                      }
                      let response = JSON.parse(this.responseText);
                      if(response.markers.length > 0) {
                        for(let i = 0; i < response.markers.length; i++) {
                            const infoWindowOth = new google.maps.InfoWindow({
                              content: response.markers[i]["comment"]
                            });
                            const markerOth = new google.maps.Marker({
                              position: {lat: parseInt(response.markers[i]["coords"]["lat"]), lng: parseInt(response.markers[i]["coords"]["lng"])},
                              map: map,
                              icon: {
                                      url: "data:image/png;base64, " + response.markers[i]["img"],
                                      scaledSize: new google.maps.Size(32, 32),
                                      origin: new google.maps.Point(0, 0),
                                      anchor: new google.maps.Point(0, 32)
                                    }
                            });

                            markerOth.addListener('click', function() {
                              infoWindowOth.open(map, markerOth);
                            });
                        }
                      }
                    }
                    
                  
                  
                  
                  $("#start-searching").click(() => {
                    const xhr = new XMLHttpRequest();

                        xhr.open('POST', '/add-marker', true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                        let body = 'lat=' + encodeURIComponent(position.coords.latitude) +
                                   '&lon=' + encodeURIComponent(position.coords.longitude) +
                                   '&comment=' + encodeURIComponent($("#comment").val()) +
                                   '&img=' + encodeURIComponent(response.img);
                        xhr.send(body);

                        xhr.onreadystatechange = function() {
                          if (this.readyState != 4) return;
                          if (this.status != 200) {
                            alert( 'error: ' + (this.status ? this.statusText : 'request has not been set') );
                            return;
                          }
                          let response = JSON.parse(this.responseText);
                        }
                    
                    
                    
                      const infoWindow = new google.maps.InfoWindow({
                        content: $("#comment").val()
                      });
                      const marker = new google.maps.Marker({
                        position: myPosition,
                        map: map,
                        icon: {
                                url: "data:image/png;base64, " + response.img,
                                scaledSize: new google.maps.Size(32, 32),
                                origin: new google.maps.Point(0, 0),
                                anchor: new google.maps.Point(0, 32)
                              }
                      });

                    marker.addListener('click', function() {
                      infoWindow.open(map, marker);
                    });

                  });
                });
              
              }   
            } 
    else {
            alert("geolocation is now working on your device/browser");
          }
                }
    </script>
    
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxlG02FmqKCtr04H3t6RQjA6D3u23K27I&callback=initMap">
    </script>
    <script src="https://code.jquery.com/jquery-2.2.1.min.js"
            integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00="
            crossorigin="anonymous"></script>
    <script src="/main_users_workflow.js"></script>

  </body>
</html>
